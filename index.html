<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Journal de trading ‚Äî Interface Am√©lior√©e</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/trade-gothic-next" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  
  <style>
    /* POLICE TRADE REPUBLIC */
    :root {
      --font-primary: 'Trade Gothic Next', 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      
      --bg: #0A0A0A;
      --bg-card: #1A1A1A;
      --fg: #F5F5F5;
      --muted: #A8A8A8;
      --accent-green: #00C48C;
      --accent-red: #FF5C63;
      --accent-blue: #00D4FF;
      --accent-purple: #8B5CF6;
      --glass: rgba(30, 30, 30, 0.95);
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      --border: rgba(255,255,255,0.1);
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
      --overlay: rgba(0,0,0,0.7);
    }

    [data-theme="light"] {
      --bg: #FFFFFF;
      --bg-card: #F8F9FA;
      --fg: #1A1A1A;
      --muted: #666666;
      --accent-green: #00A876;
      --accent-red: #E53E3E;
      --accent-blue: #007AFF;
      --accent-purple: #7C3AED;
      --glass: rgba(248, 249, 250, 0.95);
      --card-bg: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
      --border: rgba(0,0,0,0.15);
      --shadow: 0 8px 24px rgba(0,0,0,0.1);
      --overlay: rgba(0,0,0,0.4);
    }

    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
      box-sizing: border-box;
      font-family: var(--font-primary);
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font-primary);
      overflow-x: hidden;
    }

    .app {
      display: flex;
      gap: 24px;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 28px;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }

    .toast {
      padding: 14px 18px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease;
      backdrop-filter: blur(10px);
      min-height: 60px;
    }

    .toast.success {
      border-left: 4px solid var(--accent-green);
    }

    .toast.error {
      border-left: 4px solid var(--accent-red);
    }

    .toast.warning {
      border-left: 4px solid #f59e0b;
    }

    .toast.info {
      border-left: 4px solid var(--accent-blue);
    }

    .toast.fade-out {
      animation: slideOutRight 0.3s ease forwards;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .fab {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-green), #00E095);
      border: none;
      color: white;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 8px 24px rgba(0, 196, 140, 0.3);
      cursor: pointer;
      z-index: 900;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(0, 196, 140, 0.4);
    }

    .fab:active {
      transform: scale(0.95);
    }

    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .brand {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.6px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      font-size: 18px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: var(--glass);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 15px;
      min-height: 44px;
    }

    .nav-item:focus {
      outline: 2px solid var(--accent-green);
    }

    .nav-item.active {
      background: var(--glass);
      color: var(--fg);
      font-weight: 600;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .search {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 12px;
      color: var(--fg);
      flex: 1;
      min-width: 200px;
      font-size: 15px;
    }

    .btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 10px;
      color: var(--fg);
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-green), #00E095);
      color: #07110A;
      border: none;
      font-weight: 600;
    }

    .dash-grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 18px;
    }

    .card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-container {
      position: relative;
      cursor: pointer;
    }

    .chart-fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      cursor: pointer;
      color: var(--muted);
      z-index: 10;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chart-fullscreen-btn:hover {
      background: var(--accent-green);
      color: white;
    }

    .trades-list {
      max-height: 420px;
      overflow: auto;
      padding-right: 6px;
    }

    .trade-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 60px;
    }

    .trade-row:hover {
      background: var(--glass);
      transform: translateY(-1px);
    }

    .trade-row.win {
      background: linear-gradient(90deg, rgba(0,196,140,0.08), transparent);
      border-left: 3px solid var(--accent-green);
    }

    .trade-row.loss {
      background: linear-gradient(90deg, rgba(255,92,99,0.06), transparent);
      border-left: 3px solid var(--accent-red);
    }

    .mini {
      font-size: 12px;
      color: var(--muted);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    .modal {
      width: 880px;
      max-width: 95%;
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .modal-fullscreen {
      width: 95%;
      height: 90%;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    input, select, textarea {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 10px;
      color: var(--fg);
      width: 100%;
      box-sizing: border-box;
      font-size: 15px;
      min-height: 44px;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    label {
      font-size: 14px;
      margin-bottom: 8px;
      display: block;
      color: var(--muted);
      font-weight: 500;
    }

    .heatmap-section {
      margin-top: 20px;
    }

    .heatmap-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .heatmap {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      justify-items: center;
    }

    .heat-square {
      width: 100%;
      aspect-ratio: 1;
      max-width: 36px;
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease;
    }

    .heat-square:hover {
      transform: scale(1.1);
    }

    .heat-square::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .heat-square:hover::after {
      opacity: 1;
    }

    .heatmap-legend {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 12px;
      color: var(--muted);
    }

    .legend-gradient {
      flex: 1;
      height: 8px;
      margin: 0 12px;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent-red), rgba(255,255,255,0.1), var(--accent-green));
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-positive {
      color: var(--accent-green);
    }

    .metric-negative {
      color: var(--accent-red);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .chart-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .quick-add {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      display: none;
    }

    .quick-add-form {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 8px;
      align-items: end;
    }

    .quick-add-btn {
      background: var(--accent-green);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-modal .modal {
      width: 400px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }

    .auth-tab.active {
      border-bottom-color: var(--accent-green);
      color: var(--accent-green);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--accent-green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }

    .mobile-menu-btn {
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--fg);
      font-size: 20px;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      width: 44px;
      height: 44px;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1002;
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--overlay);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .input-valid {
      border-color: var(--accent-green) !important;
      background: rgba(0, 196, 140, 0.05) !important;
    }

    .input-invalid {
      border-color: var(--accent-red) !important;
      background: rgba(255, 92, 99, 0.05) !important;
    }

    .validation-message {
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }

    .validation-message.valid {
      color: var(--accent-green);
    }

    .validation-message.invalid {
      color: var(--accent-red);
    }

    /* Cases √† cocher pour graphiques */
    .chart-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--glass);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .chart-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .chart-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
    }

    @media (max-width: 1200px) {
      .dash-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .app {
        padding: 16px;
        gap: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }

      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        height: 100vh;
        height: 100dvh;
        z-index: 1001;
        transition: left 0.3s ease;
        width: 280px;
        border-radius: 0;
        border-left: 1px solid var(--border);
        background: var(--glass);
        backdrop-filter: blur(20px);
        padding-top: max(20px, env(safe-area-inset-top));
      }

      .sidebar.active {
        left: 0;
      }

      .mobile-menu-btn {
        display: flex;
      }

      .mobile-overlay.active {
        display: block;
      }

      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        margin-top: 50px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .analytics-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .heatmap {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .heat-square {
        max-width: 44px;
        font-size: 11px;
      }

      .quick-add-form {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .fab {
        display: flex;
      }

      .header .btn.primary {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }

      .header > div:last-child {
        flex-direction: column;
        width: 100%;
      }

      .header > div:last-child > * {
        width: 100%;
        margin-bottom: 8px;
      }

      .heatmap {
        grid-template-columns: repeat(3, 1fr);
      }

      .card {
        padding: 16px;
      }

      .modal {
        padding: 16px;
      }
    }

    .symbol-suggestions {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      width: 100%;
      box-shadow: var(--shadow);
      display: none;
    }

    .symbol-option {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }

    .symbol-option:hover {
      background: var(--glass);
    }

    .symbol-option:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <button class="fab" id="fabButton" title="Nouveau trade">+</button>

  <div class="mobile-overlay" id="mobileOverlay"></div>

  <div class="app">
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>

    <aside class="sidebar card" id="sidebar">
      <div class="brand">
        Journal de trading
        <button class="theme-toggle" id="themeToggle" title="Changer le th√®me">üåì</button>
      </div>
      <div class="small" id="syncStatus">‚ö° Interface ‚Ä¢ Synchronisation locale</div>
      <div style="margin-top:18px">
        <button class="nav-item active" data-view="dashboard">üìä Tableau de bord</button>
        <button class="nav-item" data-view="trades">üìà Trades</button>
        <button class="nav-item" data-view="analytics">üìâ Analytics</button>
        <button class="nav-item" data-view="import">üì• Import/Export</button>
        <button class="nav-item" data-view="settings">‚öôÔ∏è Settings</button>
      </div>
      <div style="margin-top:18px" class="small">Comptes</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="btnLogin">Se connecter</button>
        <button class="btn" id="btnSignup">S'inscrire</button>
        <button class="btn" id="btnLogout" style="display:none">D√©connexion</button>
      </div>
      <div id="userInfo" style="display:none;margin-top:8px">
        <div class="small" id="userEmail"></div>
        <div class="mini" id="lastSync"></div>
      </div>
      <div style="margin-top:20px" class="small">Raccourcis</div>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
        <button class="btn" id="btnNewTrade">+ Nouveau trade</button>
        <button class="btn" id="btnImport">Importer CSV</button>
        <button class="btn" id="btnSyncNow" style="display:none">Sync maintenant</button>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <h1 style="margin:0;font-size:20px"><span id="viewTitle">Tableau de bord</span></h1>
          <div class="small" id="viewSubtitle">Vue globale ‚Äî performance, calendrier et outils</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input placeholder="Rechercher symbole, tag..." class="search" id="globalSearch" aria-label="Rechercher trades">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <label for="topCapital" class="mini">Capital</label>
            <input id="topCapital" style="width:120px" placeholder="--" aria-label="Capital disponible" />
            <button class="btn" id="saveCapital">Sauvegarder</button>
            <button class="btn primary" id="openNew">+ Nouveau trade</button>
          </div>
        </div>
      </div>

      <div class="quick-add" id="quickAdd">
        <div style="font-weight:600;margin-bottom:12px">Ajout rapide</div>
        <form class="quick-add-form" id="quickAddForm">
          <div>
            <label for="quickSymbol" class="mini">Symbole</label>
            <input type="text" id="quickSymbol" placeholder="BTC, ETH..." required />
          </div>
          <div>
            <label for="quickSide" class="mini">Side</label>
            <select id="quickSide">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div>
            <label for="quickEntry" class="mini">Entry</label>
            <input type="number" id="quickEntry" placeholder="0.00" step="0.01" required />
          </div>
          <div>
            <label for="quickSize" class="mini">Size</label>
            <input type="number" id="quickSize" placeholder="1.0" step="0.1" required />
          </div>
          <button type="submit" class="quick-add-btn">+</button>
        </form>
      </div>

      <div class="dash-grid" id="dashboardView">
        <section>
          <div class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">Capital actuel</div>
                <div style="font-size:20px;font-weight:700">‚Ç¨ <span id="capitalDisplay">--</span></div>
              </div>
              <div style="text-align:right">
                <div class="small">Win rate</div>
                <div style="font-weight:700;font-size:18px" id="winrate">0%</div>
              </div>
            </div>
            <div style="margin-top:12px" class="chart-container">
              <button class="chart-fullscreen-btn" title="Plein √©cran">‚õ∂</button>
              <canvas id="equityChart" height="120" aria-label="Graphique d'√©volution du capital" role="img"></canvas>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:700">Performances extr√™mes</div>
              <div class="small">Best & Worst</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div style="text-align:center;padding:12px;border-radius:8px;background:linear-gradient(135deg, rgba(0,196,140,0.1), transparent);border:1px solid rgba(0,196,140,0.2)">
                <div class="mini" style="color:var(--accent-green)">Meilleur trade</div>
                <div style="font-weight:700;color:var(--accent-green)" id="bestTradeCard">-- ‚Ç¨</div>
              </div>
              <div style="text-align:center;padding:12px;border-radius:8px;background:linear-gradient(135deg, rgba(255,92,99,0.1), transparent);border:1px solid rgba(255,92,99,0.2)">
                <div class="mini" style="color:var(--accent-red)">Pire trade</div>
                <div style="font-weight:700;color:var(--accent-red)" id="worstTradeCard">-- ‚Ç¨</div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700">Trades r√©cents</div>
              <button class="btn mini" id="toggleQuickAdd" style="padding:6px 12px">+ Rapide</button>
            </div>
            <div class="trades-list" id="tradesList">
              <!-- trade rows inserted by JS -->
            </div>
          </div>

          <div class="card heatmap-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:700">Calendrier des performances</div>
              <div class="small">P&L quotidien</div>
            </div>
            <div class="heatmap-container">
              <div class="heatmap" id="heatmap" aria-label="Calendrier des performances"></div>
              <div class="heatmap-legend">
                <span>Perte</span>
                <div class="legend-gradient"></div>
                <span>Profit</span>
              </div>
            </div>
          </div>
        </section>

        <aside>
          <div class="card" style="margin-bottom:12px">
            <div style="font-weight:700;margin-bottom:8px">Calculateur Risk / Reward</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div>
                <label for="rcapital">Capital disponible (‚Ç¨)</label>
                <input id="rcapital" placeholder="Utiliser capital sauvegard√© si vide" />
              </div>
              <div>
                <label for="rrisk">Risque par trade (%)</label>
                <input id="rrisk" value="1" />
              </div>
              <div class="form-grid">
                <div>
                  <label for="rentry">Entry</label>
                  <input id="rentry" value="0" />
                </div>
                <div>
                  <label for="rstop">Stop</label>
                  <input id="rstop" value="0" />
                </div>
                <div>
                  <label for="rtarget">Target</label>
                  <input id="rtarget" value="0" />
                </div>
                <div>
                  <label for="runits">Unit√©s / coin</label>
                  <input id="runits" value="1" />
                </div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn primary" id="calcRR">Calculer</button>
                <div class="small" id="rrResult">‚Äî</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:700;margin-bottom:8px">Importer CSV</div>
            <input type="file" id="csvFile" accept=".csv" aria-label="Importer un fichier CSV" />
            <div class="small" style="margin-top:8px">Format recommand√©: symbol,side,entry_price,exit_price,size,fees,taxes,entry_timestamp,exit_timestamp,confidence,score,comment,tags</div>
          </div>
        </aside>
      </div>

      <div id="tradesView" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Tous les trades</div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="exportCSV">Exporter CSV</button>
              <button class="btn" id="clearAll">Supprimer tout</button>
            </div>
          </div>
          <div class="trades-list" id="allTradesList" style="margin-top:12px"></div>
        </div>
      </div>

      <div id="analyticsView" style="display:none">
        <div class="card">
          <div style="font-weight:700;margin-bottom:16px">Analyses d√©taill√©es</div>
          
          <div class="analytics-grid">
            <div class="metric-card">
              <div class="small">Profit Factor</div>
              <div class="metric-value" id="profitFactor">--</div>
            </div>
            <div class="metric-card">
              <div class="small">Expectancy</div>
              <div class="metric-value" id="expectancy">--</div>
            </div>
            <div class="metric-card">
              <div class="small">Max Drawdown</div>
              <div class="metric-value" id="maxDrawdown">--</div>
            </div>
            <div class="metric-card">
              <div class="small">Ratio Moyen G/P</div>
              <div class="metric-value" id="avgWinLossRatio">--</div>
            </div>
            <div class="metric-card">
              <div class="small">Sharpe Ratio</div>
              <div class="metric-value" id="sharpeRatio">--</div>
            </div>
            <div class="metric-card">
              <div class="small">Volatilit√© Mensuelle</div>
              <div class="metric-value" id="monthlyVolatility">--</div>
            </div>
          </div>

          <div class="charts-grid" style="margin-top:20px">
            <div class="chart-card">
              <div style="font-weight:600;margin-bottom:12px">Distribution des P&L</div>
              <canvas id="pnlDistributionChart" height="200"></canvas>
            </div>
            <div class="chart-card">
              <div style="font-weight:600;margin-bottom:12px">Performance par Symbole</div>
              <canvas id="symbolPerformanceChart" height="200"></canvas>
            </div>
          </div>

          <div style="margin-top:20px">
            <div style="font-weight:600;margin-bottom:12px">Statistiques avanc√©es</div>
            <div class="analytics-grid">
              <div class="metric-card">
                <div class="small">Dur√©e moyenne (jours)</div>
                <div class="metric-value" id="avgDuration">--</div>
              </div>
              <div class="metric-card">
                <div class="small">Trades/Mois</div>
                <div class="metric-value" id="tradesPerMonth">--</div>
              </div>
              <div class="metric-card">
                <div class="small">Consistance Gains</div>
                <div class="metric-value" id="winConsistency">--</div>
              </div>
              <div class="metric-card">
                <div class="small">Performance Long</div>
                <div class="metric-value" id="longPerformance">--</div>
              </div>
              <div class="metric-card">
                <div class="small">Performance Short</div>
                <div class="metric-value" id="shortPerformance">--</div>
              </div>
              <div class="metric-card">
                <div class="small">Best S√©rie Gains</div>
                <div class="metric-value" id="bestWinStreak">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="importView" style="display:none">
        <div class="card">
          <div style="font-weight:700;margin-bottom:12px">Import / Export</div>
          <p>Utilisez le widget CSV dans la barre lat√©rale ou les boutons ci-dessous :</p>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="exportCSV2">Exporter CSV</button>
            <button class="btn" id="importCSV">Importer CSV</button>
          </div>
        </div>
      </div>

      <div id="settingsView" style="display:none">
        <div class="card">
          <div style="font-weight:700">Param√®tres</div>
          <div style="margin-top:10px" class="small" id="settingsStatus">
            Sauvegarde locale ‚Ä¢ <a href="#" id="enableCloud">Activer la synchronisation cloud</a>
          </div>
          <div style="margin-top:10px">
            <label for="settingsCapital">Capital initial</label>
            <input id="settingsCapital" placeholder="--" />
            <div style="margin-top:8px">
              <button class="btn" id="saveSettings">Sauvegarder</button>
            </div>
          </div>
          <div style="margin-top:20px">
            <label for="themeSelect">Th√®me de l'interface</label>
            <select id="themeSelect" class="btn" style="width:100%">
              <option value="dark">Mode Sombre</option>
              <option value="light">Mode Clair</option>
              <option value="auto">Automatique (syst√®me)</option>
            </select>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:700" id="modalTitle">Nouveau trade</div>
        <button class="btn" id="closeModal" aria-label="Fermer la fen√™tre">Fermer</button>
      </div>
      <form id="tradeForm">
        <div class="form-grid">
          <div>
            <label for="symbol">Symbole (ex: BTC)</label>
            <input name="symbol" id="symbol" required />
            <span class="validation-message" id="symbolValidation"></span>
          </div>
          <div>
            <label for="market">Market</label>
            <select name="market" id="market">
              <option>spot</option>
              <option>futures</option>
              <option>margin</option>
            </select>
          </div>
          <div>
            <label for="side">Side</label>
            <select name="side" id="side">
              <option>long</option>
              <option>short</option>
            </select>
          </div>
          <div>
            <label for="size">Taille (units)</label>
            <input name="size" id="size" type="number" step="any" required />
            <span class="validation-message" id="sizeValidation"></span>
          </div>
          <div>
            <label for="entry_price">Prix d'entr√©e</label>
            <input name="entry_price" id="entry_price" type="number" step="any" required />
            <span class="validation-message" id="entryPriceValidation"></span>
          </div>
          <div>
            <label for="exit_price">Prix de sortie (laisser vide si ouvert)</label>
            <input name="exit_price" id="exit_price" type="number" step="any" />
          </div>
          <div>
            <label for="fees">Frais</label>
            <input name="fees" id="fees" type="number" step="any" value="0" />
          </div>
          <div>
            <label for="taxes">Taxes</label>
            <input name="taxes" id="taxes" type="number" step="any" value="0" />
          </div>
          <div>
            <label for="entry_timestamp">Date et heure d'entr√©e</label>
            <input name="entry_timestamp" id="entry_timestamp" type="datetime-local" />
          </div>
          <div>
            <label for="exit_timestamp">Date et heure de sortie</label>
            <input name="exit_timestamp" id="exit_timestamp" type="datetime-local" />
          </div>
          <div>
            <label for="timezone">Fuseau horaire</label>
            <select name="timezone" id="timezone">
              <option value="Europe/Paris">Europe/Paris</option>
              <option value="UTC">UTC</option>
              <option value="America/New_York">America/New_York</option>
              <option value="Asia/Tokyo">Asia/Tokyo</option>
            </select>
          </div>
          <div>
            <label for="confidence">Confiance (0-100)</label>
            <input name="confidence" id="confidence" type="number" min="0" max="100" value="50" />
          </div>
          <div>
            <label for="score">Note (0-100)</label>
            <input name="score" id="score" type="number" min="0" max="100" value="80" />
          </div>
          <div style="grid-column:span 2">
            <label for="comment">Commentaire</label>
            <textarea name="comment" id="comment"></textarea>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:12px;gap:8px;flex-wrap:wrap;">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" class="btn" id="markBackfill">Marquer comme pass√©</button>
            <button type="button" class="btn" id="btnNowEntry">Enregistrer entry maintenant</button>
            <button type="button" class="btn" id="btnNowExit">Enregistrer exit maintenant</button>
          </div>
          <div style="display:flex;gap:8px;">
            <button type="button" class="btn" id="deleteTrade" style="display:none">Supprimer</button>
            <button type="submit" class="btn primary" id="saveTrade">Enregistrer le trade</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Plein √âcran Am√©lior√© -->
  <div class="modal-backdrop" id="chartModal" style="display:none">
    <div class="modal modal-fullscreen" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:700">Analyses Avanc√©es - Plein √©cran</div>
        <button class="btn" id="closeChartModal">Fermer</button>
      </div>
      
      <div class="chart-controls">
        <label class="chart-checkbox">
          <input type="checkbox" id="showEquity" checked> √âquity Curve
        </label>
        <label class="chart-checkbox">
          <input type="checkbox" id="showDrawdown" checked> Drawdown
        </label>
        <label class="chart-checkbox">
          <input type="checkbox" id="showMonthlyPerf"> Performance Mensuelle
        </label>
        <label class="chart-checkbox">
          <input type="checkbox" id="showHourlyHeatmap"> Heatmap Horaire
        </label>
      </div>
      
      <div style="height:calc(100% - 120px); display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
          <div style="font-weight:600;margin-bottom:12px">√âquity & Drawdown</div>
          <canvas id="fullscreenEquityChart"></canvas>
        </div>
        <div style="background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border);">
          <div style="font-weight:600;margin-bottom:12px">Performance Mensuelle</div>
          <canvas id="fullscreenMonthlyChart"></canvas>
        </div>
        <div style="background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border); grid-column: span 2;">
          <div style="font-weight:600;margin-bottom:12px">Heatmap des Performances</div>
          <canvas id="fullscreenHeatmapChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop auth-modal" id="authModal" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:700" id="authTitle">Connexion</div>
        <button class="btn" id="closeAuthModal">Fermer</button>
      </div>
      
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Connexion</div>
        <div class="auth-tab" data-tab="signup">Inscription</div>
      </div>
      
      <form id="authForm">
        <div style="display:flex;flex-direction:column;gap:12px">
          <div>
            <label for="authEmail">Email</label>
            <input type="email" id="authEmail" required />
          </div>
          <div>
            <label for="authPassword">Mot de passe</label>
            <input type="password" id="authPassword" required minlength="6" />
          </div>
          <div id="authConfirmPassword" style="display:none">
            <label for="confirmPassword">Confirmer le mot de passe</label>
            <input type="password" id="confirmPassword" minlength="6" />
          </div>
          <button type="submit" class="btn primary" id="authSubmit">Se connecter</button>
        </div>
      </form>
      
      <div class="small" style="margin-top:12px;text-align:center">
        <div id="authMessage"></div>
        <div style="margin-top:8px">En vous connectant, vos donn√©es seront synchronis√©es sur tous vos appareils</div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDGfiBOOEZiLZmh7clQlSZAr1W6P6Si8vM",
      authDomain: "journaltrading-a6bc6.firebaseapp.com",
      projectId: "journaltrading-a6bc6",
      storageBucket: "journaltrading-a6bc6.firebasestorage.app",
      messagingSenderId: "220303277331",
      appId: "1:220303277331:web:f4251eebd62d3058f82ee6",
      measurementId: "G-8EEHYVXQS6"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ========== √âTAT GLOBAL UNIFI√â ==========
    const AppState = {
      trades: [],
      capital: null,
      currentUser: null,
      currentEditing: null,
      
      // Nouveau: Stockage s√©par√© par utilisateur
      getStorageKey() {
        const userId = this.currentUser ? this.currentUser.uid : 'guest';
        return `trading_journal_v4_${userId}`;
      },
      
      getCapitalKey() {
        const userId = this.currentUser ? this.currentUser.uid : 'guest';
        return `capital_${userId}`;
      },
      
      init() {
        this.loadFromLocal();
      },
      
      loadFromLocal() {
        try {
          const storageKey = this.getStorageKey();
          const capitalKey = this.getCapitalKey();
          
          const storedTrades = localStorage.getItem(storageKey);
          const storedCapital = localStorage.getItem(capitalKey);
          
          this.trades = storedTrades ? JSON.parse(storedTrades) : [];
          this.capital = storedCapital ? parseFloat(storedCapital) : null;
          this.trades = this.trades.filter(t => t && t.id && t.symbol);
          console.log('Donn√©es locales charg√©es pour', this.currentUser?.email || 'guest', ':', this.trades.length, 'trades');
        } catch (error) {
          console.error('Error loading data:', error);
          this.trades = [];
          this.capital = null;
        }
      },
      
      persistToLocal() {
        try {
          const storageKey = this.getStorageKey();
          const capitalKey = this.getCapitalKey();
          
          localStorage.setItem(storageKey, JSON.stringify(this.trades));
          if (this.capital !== null) {
            localStorage.setItem(capitalKey, this.capital.toString());
          }
          return true;
        } catch (error) {
          console.error('Error saving data:', error);
          showToast('Erreur lors de la sauvegarde locale', 'error');
          return false;
        }
      },
      
      async persist() {
        const localSuccess = this.persistToLocal();
        if (this.currentUser) {
          await this.syncToCloud();
        }
        return localSuccess;
      },
      
      // ========== SYNCHRO CLOUD ==========
      async syncToCloud() {
        if (!this.currentUser) {
          console.log('syncToCloud: Aucun utilisateur connect√©');
          return false;
        }
        
        try {
          console.log('üîÑ D√©but synchronisation avec', this.trades.length, 'trades');
          showToast('Synchronisation en cours...', 'info');
          
          let successCount = 0;
          let errorCount = 0;
          
          if (!this.trades || this.trades.length === 0) {
            console.log('Aucun trade √† synchroniser');
            updateSyncStatus('‚úÖ Aucun trade √† synchroniser', true);
            return true;
          }
          
          for (const trade of this.trades) {
            try {
              if (!trade.id || !trade.symbol) {
                console.warn('Trade invalide ignor√©:', trade);
                errorCount++;
                continue;
              }
              
              const tradeData = {
                id: trade.id,
                symbol: trade.symbol || '',
                side: trade.side || 'long',
                entry_price: Number(trade.entry_price) || 0,
                exit_price: trade.exit_price ? Number(trade.exit_price) : null,
                size: Number(trade.size) || 0,
                fees: Number(trade.fees) || 0,
                taxes: Number(trade.taxes) || 0,
                entry_timestamp: trade.entry_timestamp || new Date().toISOString(),
                exit_timestamp: trade.exit_timestamp || null,
                confidence: Number(trade.confidence) || 50,
                score: Number(trade.score) || 50,
                comment: trade.comment || '',
                market: trade.market || 'spot',
                timezone: trade.timezone || 'Europe/Paris',
                userId: this.currentUser.uid,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              if (trade.notional) tradeData.notional = Number(trade.notional);
              if (trade.computed_pnl !== undefined && trade.computed_pnl !== null) {
                tradeData.computed_pnl = Number(trade.computed_pnl);
              }
              if (trade.duration_seconds) tradeData.duration_seconds = Number(trade.duration_seconds);
              
              console.log(`üì§ Synchronisation de ${trade.symbol}...`);
              
              const tradeRef = db.collection('trades').doc(trade.id);
              await tradeRef.set(tradeData, { merge: true });
              
              successCount++;
              console.log(`‚úÖ ${trade.symbol} synchronis√©`);
              
            } catch (error) {
              console.error(`‚ùå Erreur sur ${trade.symbol}:`, error);
              errorCount++;
            }
          }
          
          console.log(`üìä Synchronisation termin√©e: ${successCount} r√©ussis, ${errorCount} erreurs`);
          
          if (successCount > 0) {
            const message = `${successCount} trade(s) synchronis√©(s)`;
            updateSyncStatus(`‚úÖ ${message}`, true);
            
            if (errorCount > 0) {
              showAlert(`${message}, ${errorCount} erreur(s)`, 'warning');
            } else {
              showAlert('Synchronisation r√©ussie !', 'success');
            }
            return true;
          } else {
            throw new Error(`Aucun trade synchronis√© (${errorCount} erreurs)`);
          }
          
        } catch (error) {
          console.error('üí• Erreur g√©n√©rale de synchronisation:', error);
          updateSyncStatus('‚ùå Sync √©chou√©e', false);
          showAlert('Erreur: ' + error.message, 'error');
          return false;
        }
      },
      
      async loadFromCloud() {
        if (!this.currentUser) {
          console.log('loadFromCloud: Aucun utilisateur connect√©');
          return false;
        }
        
        try {
          console.log('üì• Chargement depuis le cloud...');
          
          const snapshot = await db.collection('trades')
            .where('userId', '==', this.currentUser.uid)
            .orderBy('updated_at', 'desc')
            .get();
          
          console.log(`${snapshot.size} trades trouv√©s dans le cloud`);
          
          if (snapshot.empty) {
            console.log('Aucun trade dans le cloud');
            return true;
          }
          
          const cloudTrades = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.updated_at && typeof data.updated_at.toDate === 'function') {
              data.updated_at = data.updated_at.toDate().toISOString();
            }
            cloudTrades.push(data);
          });
          
          const beforeCount = this.trades.length;
          this.mergeTrades(cloudTrades);
          const afterCount = this.trades.length;
          
          console.log(`üîÑ Fusion: ${beforeCount} -> ${afterCount} trades`);
          
          this.persistToLocal();
          
          showToast(`${cloudTrades.length} trades charg√©s du cloud`, 'success');
          return true;
          
        } catch (error) {
          console.error('‚ùå Erreur loadFromCloud:', error);
          showAlert('Erreur chargement cloud: ' + error.message, 'error');
          return false;
        }
      },
      
      mergeTrades(cloudTrades) {
        const tradeMap = new Map();
        
        cloudTrades.forEach(cloudTrade => {
          tradeMap.set(cloudTrade.id, { ...cloudTrade, source: 'cloud' });
        });
        
        this.trades.forEach(localTrade => {
          const existing = tradeMap.get(localTrade.id);
          if (!existing) {
            tradeMap.set(localTrade.id, { ...localTrade, source: 'local' });
          } else {
            const localUpdated = new Date(localTrade.updated_at || localTrade.entry_timestamp || 0);
            const cloudUpdated = new Date(existing.updated_at || existing.entry_timestamp || 0);
            
            if (localUpdated > cloudUpdated) {
              tradeMap.set(localTrade.id, { ...localTrade, source: 'local' });
            }
          }
        });
        
        this.trades = Array.from(tradeMap.values());
      }
    };

    // ========== FONCTIONS UTILITAIRES ==========
    function showToast(message, type = 'info', duration = 4000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: 'üí°'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-message">${message}</div>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
      
      return toast;
    }

    function showAlert(message, type = 'info') {
      return showToast(message, type, 5000);
    }

    function cryptoRandomId(){ return 't_'+Math.random().toString(36).slice(2,10) + '_' + Date.now().toString(36); }

    function computePnL(tr){ 
      if(!tr || tr.exit_price == null || tr.entry_price == null || tr.size == null) return null; 
      if(tr.entry_price <= 0 || tr.size <= 0) return null;
      
      let pnl;
      if(tr.side === 'long') {
        pnl = (tr.exit_price - tr.entry_price) * tr.size - (tr.fees || 0) - (tr.taxes || 0);
      } else {
        pnl = (tr.entry_price - tr.exit_price) * tr.size - (tr.fees || 0) - (tr.taxes || 0);
      }
      return parseFloat(pnl.toFixed(2));
    }
    
    function safeDateParse(dateString) {
      if (!dateString) return null;
      const date = new Date(dateString);
      return isNaN(date.getTime()) ? null : date;
    }
    
    function calculateDuration(entryTimestamp, exitTimestamp) {
      if (!entryTimestamp || !exitTimestamp) return null;
      const entry = safeDateParse(entryTimestamp);
      const exit = safeDateParse(exitTimestamp);
      if (!entry || !exit) return null;
      return Math.floor((exit - entry) / 1000);
    }
    
    function validateTrade(t) {
      const errors = [];
      
      if (!t.symbol || t.symbol.trim() === '') {
        errors.push('Le symbole est requis');
      }
      if (!t.entry_price || t.entry_price <= 0) {
        errors.push('Le prix d\'entr√©e doit √™tre positif');
      }
      if (!t.size || t.size <= 0) {
        errors.push('La taille doit √™tre positive');
      }
      if (t.side !== 'long' && t.side !== 'short') {
        errors.push('Le side doit √™tre "long" ou "short"');
      }
      
      if (errors.length > 0) {
        throw new Error(errors.join(', '));
      }
      return true;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ========== CALCULS ANALYTICS AVANC√âS ==========
    function calculateAdvancedMetrics() {
      const closedTrades = AppState.trades.filter(t => t.computed_pnl != null);
      if (closedTrades.length === 0) return {};
      
      const winningTrades = closedTrades.filter(t => t.computed_pnl > 0);
      const losingTrades = closedTrades.filter(t => t.computed_pnl < 0);
      
      // Profit Factor
      const totalProfit = winningTrades.reduce((sum, t) => sum + t.computed_pnl, 0);
      const totalLoss = Math.abs(losingTrades.reduce((sum, t) => sum + t.computed_pnl, 0));
      const profitFactor = totalLoss > 0 ? (totalProfit / totalLoss) : totalProfit > 0 ? Infinity : 0;
      
      // Expectancy
      const avgWin = winningTrades.length > 0 ? totalProfit / winningTrades.length : 0;
      const avgLoss = losingTrades.length > 0 ? totalLoss / losingTrades.length : 0;
      const winRate = winningTrades.length / closedTrades.length;
      const expectancy = (winRate * avgWin) - ((1 - winRate) * avgLoss);
      
      // Max Drawdown
      let maxDrawdown = 0;
      let peak = AppState.capital || 0;
      let equity = AppState.capital || 0;
      
      closedTrades.sort((a, b) => new Date(a.exit_timestamp) - new Date(b.exit_timestamp));
      
      closedTrades.forEach(trade => {
        equity += trade.computed_pnl;
        if (equity > peak) peak = equity;
        const drawdown = ((peak - equity) / peak) * 100;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
      });
      
      // Ratio Gain/Perte
      const avgWinLossRatio = avgLoss > 0 ? avgWin / avgLoss : avgWin > 0 ? Infinity : 0;
      
      // Sharpe Ratio (simplifi√©)
      const returns = closedTrades.map(t => t.computed_pnl / (t.notional || 1));
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const stdDev = Math.sqrt(returns.map(r => Math.pow(r - avgReturn, 2)).reduce((a, b) => a + b, 0) / returns.length);
      const sharpeRatio = stdDev > 0 ? avgReturn / stdDev : 0;
      
      // Volatilit√© Mensuelle
      const monthlyReturns = calculateMonthlyReturns(closedTrades);
      const monthlyVolatility = calculateVolatility(monthlyReturns);
      
      // Autres m√©triques
      const durations = closedTrades.map(t => t.duration_seconds || 0).filter(d => d > 0);
      const avgDuration = durations.length > 0 ? durations.reduce((a, b) => a + b, 0) / durations.length / (24 * 3600) : 0;
      
      const tradesByMonth = groupTradesByMonth(closedTrades);
      const tradesPerMonth = Object.values(tradesByMonth).reduce((a, b) => a + b, 0) / Math.max(Object.keys(tradesByMonth).length, 1);
      
      // Consistance des gains
      const monthlyPnL = calculateMonthlyPnL(closedTrades);
      const profitableMonths = Object.values(monthlyPnL).filter(pnl => pnl > 0).length;
      const winConsistency = (profitableMonths / Math.max(Object.keys(monthlyPnL).length, 1)) * 100;
      
      // Performance par side
      const longTrades = closedTrades.filter(t => t.side === 'long');
      const shortTrades = closedTrades.filter(t => t.side === 'short');
      const longPerformance = longTrades.reduce((sum, t) => sum + t.computed_pnl, 0);
      const shortPerformance = shortTrades.reduce((sum, t) => sum + t.computed_pnl, 0);
      
      // Best s√©rie de gains
      const bestWinStreak = calculateBestWinStreak(closedTrades);
      
      return {
        profitFactor: profitFactor.toFixed(2),
        expectancy: expectancy.toFixed(2),
        maxDrawdown: maxDrawdown.toFixed(2) + '%',
        avgWinLossRatio: avgWinLossRatio.toFixed(2),
        sharpeRatio: sharpeRatio.toFixed(2),
        monthlyVolatility: (monthlyVolatility * 100).toFixed(2) + '%',
        avgDuration: avgDuration.toFixed(1),
        tradesPerMonth: tradesPerMonth.toFixed(1),
        winConsistency: winConsistency.toFixed(1) + '%',
        longPerformance: longPerformance.toFixed(2) + ' ‚Ç¨',
        shortPerformance: shortPerformance.toFixed(2) + ' ‚Ç¨',
        bestWinStreak: bestWinStreak
      };
    }
    
    function calculateMonthlyReturns(trades) {
      const monthly = {};
      trades.forEach(trade => {
        const date = new Date(trade.exit_timestamp);
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        if (!monthly[monthKey]) monthly[monthKey] = [];
        monthly[monthKey].push(trade.computed_pnl / (trade.notional || 1));
      });
      
      return Object.values(monthly).map(returns => 
        returns.reduce((a, b) => a + b, 0) / returns.length
      );
    }
    
    function calculateVolatility(returns) {
      if (returns.length < 2) return 0;
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.map(r => Math.pow(r - avgReturn, 2)).reduce((a, b) => a + b, 0) / returns.length;
      return Math.sqrt(variance);
    }
    
    function groupTradesByMonth(trades) {
      const months = {};
      trades.forEach(trade => {
        const date = new Date(trade.exit_timestamp);
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        months[monthKey] = (months[monthKey] || 0) + 1;
      });
      return months;
    }
    
    function calculateMonthlyPnL(trades) {
      const monthly = {};
      trades.forEach(trade => {
        const date = new Date(trade.exit_timestamp);
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        monthly[monthKey] = (monthly[monthKey] || 0) + trade.computed_pnl;
      });
      return monthly;
    }
    
    function calculateBestWinStreak(trades) {
      let currentStreak = 0;
      let bestStreak = 0;
      
      trades.sort((a, b) => new Date(a.exit_timestamp) - new Date(b.exit_timestamp));
      
      trades.forEach(trade => {
        if (trade.computed_pnl > 0) {
          currentStreak++;
          bestStreak = Math.max(bestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      
      return bestStreak;
    }

    // ========== GRAPHIQUES ANALYTICS ==========
    function initAnalyticsCharts() {
      initPnlDistributionChart();
      initSymbolPerformanceChart();
    }
    
    function initPnlDistributionChart() {
      const ctx = document.getElementById('pnlDistributionChart');
      if (!ctx) return;
      
      const closedTrades = AppState.trades.filter(t => t.computed_pnl != null);
      if (closedTrades.length === 0) return;
      
      const pnls = closedTrades.map(t => t.computed_pnl);
      const minPnl = Math.min(...pnls);
      const maxPnl = Math.max(...pnls);
      const range = maxPnl - minPnl;
      const binCount = Math.min(10, Math.ceil(Math.sqrt(closedTrades.length)));
      const binSize = range / binCount;
      
      const bins = Array(binCount).fill(0);
      pnls.forEach(pnl => {
        const binIndex = Math.min(Math.floor((pnl - minPnl) / binSize), binCount - 1);
        bins[binIndex]++;
      });
      
      const labels = Array.from({length: binCount}, (_, i) => {
        const start = minPnl + (i * binSize);
        const end = start + binSize;
        return `${start.toFixed(0)}-${end.toFixed(0)}`;
      });
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const backgroundColor = pnls.map(pnl => pnl >= 0 ? 'rgba(0, 196, 140, 0.7)' : 'rgba(255, 92, 99, 0.7)');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Nombre de trades',
            data: bins,
            backgroundColor: backgroundColor,
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              title: { display: true, text: 'P&L (‚Ç¨)' },
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y: {
              title: { display: true, text: 'Fr√©quence' },
              beginAtZero: true,
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            }
          }
        }
      });
    }
    
    function initSymbolPerformanceChart() {
      const ctx = document.getElementById('symbolPerformanceChart');
      if (!ctx) return;
      
      const closedTrades = AppState.trades.filter(t => t.computed_pnl != null);
      if (closedTrades.length === 0) return;
      
      const symbolPerformance = {};
      closedTrades.forEach(trade => {
        if (!symbolPerformance[trade.symbol]) {
          symbolPerformance[trade.symbol] = { total: 0, count: 0 };
        }
        symbolPerformance[trade.symbol].total += trade.computed_pnl;
        symbolPerformance[trade.symbol].count++;
      });
      
      const symbols = Object.keys(symbolPerformance).slice(0, 10); // Top 10
      const performances = symbols.map(symbol => symbolPerformance[symbol].total);
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: symbols,
          datasets: [{
            label: 'P&L Total (‚Ç¨)',
            data: performances,
            backgroundColor: performances.map(p => p >= 0 ? 'rgba(0, 196, 140, 0.7)' : 'rgba(255, 92, 99, 0.7)'),
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y: {
              beginAtZero: true,
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            }
          }
        }
      });
    }

    // ========== GRAPHIQUES PLEIN √âCRAN ==========
    let fullscreenCharts = {};
    
    function initFullscreenCharts() {
      const equityCtx = document.getElementById('fullscreenEquityChart');
      const monthlyCtx = document.getElementById('fullscreenMonthlyChart');
      const heatmapCtx = document.getElementById('fullscreenHeatmapChart');
      
      if (equityCtx) fullscreenCharts.equity = createFullscreenEquityChart(equityCtx);
      if (monthlyCtx) fullscreenCharts.monthly = createFullscreenMonthlyChart(monthlyCtx);
      if (heatmapCtx) fullscreenCharts.heatmap = createFullscreenHeatmapChart(heatmapCtx);
    }
    
    function createFullscreenEquityChart(ctx) {
      const closed = AppState.trades.filter(t => t.computed_pnl != null).sort((a, b) => 
        new Date(a.exit_timestamp) - new Date(b.exit_timestamp)
      );
      
      let equity = AppState.capital || 0;
      let peak = equity;
      const labels = [];
      const equityData = [];
      const drawdownData = [];
      
      labels.push('D√©but');
      equityData.push(equity);
      drawdownData.push(0);
      
      closed.forEach(trade => {
        equity += trade.computed_pnl;
        if (equity > peak) peak = equity;
        const drawdown = ((peak - equity) / peak) * 100;
        
        const date = new Date(trade.exit_timestamp);
        labels.push(date.toLocaleDateString('fr-FR'));
        equityData.push(parseFloat(equity.toFixed(2)));
        drawdownData.push(parseFloat(drawdown.toFixed(2)));
      });
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Equity',
              data: equityData,
              borderColor: 'var(--accent-green)',
              backgroundColor: 'rgba(0, 196, 140, 0.1)',
              fill: true,
              yAxisID: 'y',
              tension: 0.2
            },
            {
              label: 'Drawdown (%)',
              data: drawdownData,
              borderColor: 'var(--accent-red)',
              backgroundColor: 'rgba(255, 92, 99, 0.1)',
              fill: false,
              yAxisID: 'y1',
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          scales: {
            x: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { callback: value => value + '%' }
            }
          }
        }
      });
    }
    
    function createFullscreenMonthlyChart(ctx) {
      const closed = AppState.trades.filter(t => t.computed_pnl != null);
      const monthlyPnL = {};
      
      closed.forEach(trade => {
        const date = new Date(trade.exit_timestamp);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        monthlyPnL[monthKey] = (monthlyPnL[monthKey] || 0) + trade.computed_pnl;
      });
      
      const months = Object.keys(monthlyPnL).sort();
      const pnls = months.map(month => monthlyPnL[month]);
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'P&L Mensuel (‚Ç¨)',
            data: pnls,
            backgroundColor: pnls.map(pnl => pnl >= 0 ? 'rgba(0, 196, 140, 0.7)' : 'rgba(255, 92, 99, 0.7)'),
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            }
          }
        }
      });
    }
    
    function createFullscreenHeatmapChart(ctx) {
      const closed = AppState.trades.filter(t => t.computed_pnl != null);
      const hourlyPerformance = {};
      
      // Initialiser toutes les heures
      for (let hour = 0; hour < 24; hour++) {
        hourlyPerformance[hour] = { total: 0, count: 0 };
      }
      
      closed.forEach(trade => {
        const date = new Date(trade.exit_timestamp);
        const hour = date.getHours();
        hourlyPerformance[hour].total += trade.computed_pnl;
        hourlyPerformance[hour].count++;
      });
      
      const hours = Object.keys(hourlyPerformance).map(Number).sort((a, b) => a - b);
      const avgPnls = hours.map(hour => 
        hourlyPerformance[hour].count > 0 ? hourlyPerformance[hour].total / hourlyPerformance[hour].count : 0
      );
      
      const maxPnl = Math.max(...avgPnls.map(Math.abs));
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: hours.map(h => `${h}h`),
          datasets: [{
            label: 'P&L Moyen par Heure (‚Ç¨)',
            data: avgPnls,
            backgroundColor: avgPnls.map(pnl => {
              if (pnl === 0) return 'rgba(128, 128, 128, 0.7)';
              const intensity = Math.abs(pnl) / maxPnl;
              return pnl > 0 
                ? `rgba(0, 196, 140, ${0.3 + intensity * 0.7})`
                : `rgba(255, 92, 99, ${0.3 + intensity * 0.7})`;
            }),
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            },
            y: {
              grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' }
            }
          }
        }
      });
    }
    
    function updateFullscreenCharts() {
      Object.values(fullscreenCharts).forEach(chart => {
        if (chart) chart.destroy();
      });
      initFullscreenCharts();
    }

    // ========== GESTION DE L'UI ==========
    function updateSyncStatus(message, isSuccess = true) {
      const statusElement = document.getElementById('syncStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.style.color = isSuccess ? 'var(--accent-green)' : 'var(--accent-red)';
      }
      
      const lastSyncElement = document.getElementById('lastSync');
      if (lastSyncElement && isSuccess) {
        lastSyncElement.textContent = `Sync: ${new Date().toLocaleTimeString()}`;
      }
    }
    
    function updateUIForUser() {
      if (AppState.currentUser) {
        document.getElementById('btnLogin').style.display = 'none';
        document.getElementById('btnSignup').style.display = 'none';
        document.getElementById('btnLogout').style.display = 'inline-block';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('btnSyncNow').style.display = 'inline-block';
        document.getElementById('userEmail').textContent = AppState.currentUser.email;
        document.getElementById('settingsStatus').innerHTML = 'Synchronisation Firebase activ√©e';
        
        updateSyncStatus('‚úÖ Connect√© ‚Ä¢ Synchronisation Firebase', true);
      } else {
        document.getElementById('btnLogin').style.display = 'inline-block';
        document.getElementById('btnSignup').style.display = 'inline-block';
        document.getElementById('btnLogout').style.display = 'none';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('btnSyncNow').style.display = 'none';
        document.getElementById('settingsStatus').innerHTML = 'Sauvegarde locale ‚Ä¢ <a href="#" id="enableCloud">Activer la synchronisation cloud</a>';
        
        updateSyncStatus('‚ö° Mode hors ligne ‚Ä¢ Donn√©es locales', false);
      }
    }

    // ========== GESTION DU TH√àME ==========
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeSelect').value = savedTheme;
      
      const themeIcon = document.getElementById('themeToggle');
      if (savedTheme === 'dark') {
        themeIcon.textContent = 'üåô';
      } else {
        themeIcon.textContent = '‚òÄÔ∏è';
      }
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeIcon = document.getElementById('themeToggle');
      themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      
      setTimeout(() => {
        if (equityChart) {
          equityChart.destroy();
          initChart();
          updateChart();
        }
        initAnalyticsCharts();
        updateFullscreenCharts();
      }, 100);
    }

    // ========== GESTION MOBILE ==========
    function initMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileOverlay = document.getElementById('mobileOverlay');
      
      function openSidebar() {
        sidebar.classList.add('active');
        mobileOverlay.classList.add('active');
      }
      
      function closeSidebar() {
        sidebar.classList.remove('active');
        mobileOverlay.classList.remove('active');
      }
      
      mobileMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (sidebar.classList.contains('active')) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });
      
      mobileOverlay.addEventListener('click', closeSidebar);
      
      sidebar.addEventListener('click', (e) => {
        if (e.target.classList.contains('nav-item') || e.target.closest('.nav-item')) {
          setTimeout(closeSidebar, 300);
        }
      });
    }

    // ========== QUICK ADD TRADE ==========
    function initQuickAdd() {
      const quickAdd = document.getElementById('quickAdd');
      const quickAddForm = document.getElementById('quickAddForm');
      const toggleBtn = document.getElementById('toggleQuickAdd');
      
      toggleBtn.addEventListener('click', () => {
        quickAdd.style.display = quickAdd.style.display === 'none' ? 'block' : 'none';
      });
      
      quickAddForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const symbol = document.getElementById('quickSymbol').value.trim();
        const side = document.getElementById('quickSide').value;
        const entry = parseFloat(document.getElementById('quickEntry').value);
        const size = parseFloat(document.getElementById('quickSize').value);
        
        if (!symbol || !entry || !size) {
          showAlert('Veuillez remplir tous les champs', 'error');
          return;
        }
        
        const newTrade = {
          id: cryptoRandomId(),
          symbol: symbol.toUpperCase(),
          side: side,
          entry_price: entry,
          size: size,
          fees: 0,
          taxes: 0,
          entry_timestamp: new Date().toISOString(),
          exit_timestamp: null,
          confidence: 50,
          score: 50,
          comment: 'Trade rapide',
          market: 'spot',
          timezone: 'Europe/Paris'
        };
        
        newTrade.notional = newTrade.entry_price * newTrade.size;
        newTrade.computed_pnl = null;
        newTrade.duration_seconds = null;
        newTrade.updated_at = new Date().toISOString();
        
        try {
          validateTrade(newTrade);
          AppState.trades.unshift(newTrade);
          AppState.persist();
          renderAll();
          quickAddForm.reset();
          quickAdd.style.display = 'none';
          showAlert('Trade ajout√© avec succ√®s!', 'success');
        } catch (error) {
          showAlert('Erreur: ' + error.message, 'error');
        }
      });
    }

    // ========== RENDU DES TRADES ==========
    function renderTrades(){
      const tradesList = document.getElementById('tradesList');
      if (!tradesList) return;
      
      tradesList.innerHTML='';
      const recentTrades = AppState.trades.slice(0, 30);
      
      if (recentTrades.length === 0) {
        tradesList.innerHTML = '<div class="trade-row"><div class="mini">Aucun trade enregistr√©</div></div>';
        return;
      }
      
      recentTrades.forEach(tr => {
        const row = document.createElement('div');
        const pnl = tr.computed_pnl;
        row.className = 'trade-row ' + (pnl == null ? '' : (pnl >= 0 ? 'win' : 'loss'));
        row.setAttribute('role', 'button');
        row.tabIndex = 0;
        
        const pnlPercent = tr.computed_pnl == null ? '‚Äî' : 
          ((tr.computed_pnl / (tr.notional || 1)) * 100).toFixed(2) + '%';
        
        row.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:56px;font-weight:700">${tr.symbol}</div>
            <div style="min-width:120px">
              <div class="mini">${tr.side.toUpperCase()}</div>
              <div>${tr.size} @ ${tr.entry_price}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${pnl == null ? 'OUVERT' : (pnl >= 0 ? '+' : '') + pnl.toFixed(2) + ' ‚Ç¨'}</div>
            <div class="mini">${pnlPercent}</div>
          </div>
        `;
        
        row.addEventListener('click', () => openTradeDetail(tr.id));
        tradesList.appendChild(row);
      });
    }

    function renderAllTradesTable(){
      const allTradesList = document.getElementById('allTradesList');
      if (!allTradesList) return;
      
      allTradesList.innerHTML='';
      
      if (AppState.trades.length === 0) {
        allTradesList.innerHTML = '<div class="trade-row"><div class="mini">Aucun trade enregistr√©</div></div>';
        return;
      }
      
      AppState.trades.forEach(t => {
        const r = document.createElement('div'); 
        r.className = 'trade-row ' + (t.computed_pnl == null ? '' : (t.computed_pnl >= 0 ? 'win' : 'loss'));
        r.style.cursor='pointer';
        r.setAttribute('role', 'button');
        r.tabIndex = 0;
        
        r.innerHTML = `
          <div>
            ${t.symbol} ${t.side}
            ${t.comment ? `<div class="mini">${t.comment.substring(0, 30)}${t.comment.length > 30 ? '...' : ''}</div>` : ''}
          </div>
          <div>${t.computed_pnl == null ? 'OUVERT' : (t.computed_pnl >= 0 ? '+' : '') + t.computed_pnl.toFixed(2) + ' ‚Ç¨'}</div>
        `;
        
        r.addEventListener('click', () => openTradeDetail(t.id));
        allTradesList.appendChild(r);
      });
    }

    function renderStats(){
      const closed = AppState.trades.filter(t => t.computed_pnl != null);
      const wins = closed.filter(t => t.computed_pnl > 0);
      const wr = closed.length ? Math.round((wins.length / closed.length) * 100) : 0;
      
      // M√©triques de base
      if (document.getElementById('winrate')) {
        document.getElementById('winrate').textContent = wr + '%';
      }
      
      const capitalDisplay = document.getElementById('capitalDisplay');
      if (capitalDisplay) {
        if (AppState.capital == null) { 
          capitalDisplay.textContent = '--'; 
        } else { 
          const pnlSum = closed.reduce((s, t) => s + (t.computed_pnl || 0), 0); 
          const newCapital = (AppState.capital + pnlSum).toFixed(2); 
          capitalDisplay.textContent = newCapital; 
        }
      }
      
      // Best/Worst trades
      const bestTrade = closed.length > 0 ? Math.max(...closed.map(t => t.computed_pnl)) : 0;
      const worstTrade = closed.length > 0 ? Math.min(...closed.map(t => t.computed_pnl)) : 0;
      
      document.getElementById('bestTradeCard').textContent = bestTrade.toFixed(2) + ' ‚Ç¨';
      document.getElementById('worstTradeCard').textContent = worstTrade.toFixed(2) + ' ‚Ç¨';
      
      // Analytics avanc√©es
      const metrics = calculateAdvancedMetrics();
      
      document.getElementById('profitFactor').textContent = metrics.profitFactor || '--';
      document.getElementById('expectancy').textContent = metrics.expectancy || '--';
      document.getElementById('maxDrawdown').textContent = metrics.maxDrawdown || '--';
      document.getElementById('avgWinLossRatio').textContent = metrics.avgWinLossRatio || '--';
      document.getElementById('sharpeRatio').textContent = metrics.sharpeRatio || '--';
      document.getElementById('monthlyVolatility').textContent = metrics.monthlyVolatility || '--';
      document.getElementById('avgDuration').textContent = metrics.avgDuration || '--';
      document.getElementById('tradesPerMonth').textContent = metrics.tradesPerMonth || '--';
      document.getElementById('winConsistency').textContent = metrics.winConsistency || '--';
      document.getElementById('longPerformance').textContent = metrics.longPerformance || '--';
      document.getElementById('shortPerformance').textContent = metrics.shortPerformance || '--';
      document.getElementById('bestWinStreak').textContent = metrics.bestWinStreak || '--';
    }

    function renderAll(){ 
      renderTrades(); 
      renderAllTradesTable(); 
      renderStats(); 
      updateChart();
      initAnalyticsCharts();
    }

    // ========== GESTION DES VUES ==========
    function showView(v){
      document.getElementById('viewTitle').textContent = (
        v==='dashboard'? 'Tableau de bord' : v==='trades'? 'Trades' : v==='analytics'? 'Analytics' : v==='import'? 'Import/Export' : 'Param√®tres'
      );
      ['dashboardView','tradesView','analyticsView','importView','settingsView'].forEach(id=> 
        document.getElementById(id).style.display = 'none');
      if(v==='dashboard') document.getElementById('dashboardView').style.display='grid';
      if(v==='trades') document.getElementById('tradesView').style.display='block';
      if(v==='analytics') document.getElementById('analyticsView').style.display='block';
      if(v==='import') document.getElementById('importView').style.display='block';
      if(v==='settings') document.getElementById('settingsView').style.display='block';
    }

    // ========== GRAPHIQUES ==========
    let equityChart = null;
    
    function initChart() {
      const ctx = document.getElementById('equityChart');
      if (!ctx) return;
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const gridColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)';
      const textColor = isDark ? 'var(--muted)' : 'var(--muted)';
      
      equityChart = new Chart(ctx.getContext('2d'), { 
        type: 'line', 
        data: {
          labels:[],
          datasets:[{
            label:'Equity',
            data:[],
            fill: true,
            tension: 0.2,
            backgroundColor: 'rgba(0, 196, 140, 0.1)',
            borderColor: 'var(--accent-green)',
            borderWidth: 3,
            pointBackgroundColor: 'var(--accent-green)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        }, 
        options:{
          responsive: true,
          maintainAspectRatio: false,
          scales:{
            x:{
              display: true,
              grid: { color: gridColor },
              ticks: { color: textColor }
            },
            y:{
              beginAtZero:false,
              grid: { color: gridColor },
              ticks: { color: textColor }
            }
          },
          plugins:{
            legend:{display:false}
          }
        }
      });
    }
    
    function updateChart(){ 
      if (!equityChart) return;
      
      const closed = AppState.trades.filter(t => t.computed_pnl != null).slice().reverse(); 
      let eq = AppState.capital || 0; 
      const labels = []; 
      const data = []; 
      
      if (AppState.capital != null) {
        labels.push('D√©but');
        data.push(parseFloat(AppState.capital.toFixed(2)));
      }
      
      closed.forEach(t => { 
        eq += t.computed_pnl || 0; 
        const date = t.exit_timestamp ? new Date(t.exit_timestamp) : new Date();
        labels.push(date.toLocaleDateString('fr-FR')); 
        data.push(parseFloat(eq.toFixed(2))); 
      }); 
      
      if(data.length === 0 && AppState.capital != null){ 
        equityChart.data.labels = ['D√©but']; 
        equityChart.data.datasets[0].data = [AppState.capital]; 
      } else { 
        equityChart.data.labels = labels; 
        equityChart.data.datasets[0].data = data; 
      } 
      
      equityChart.update();
    }

    // ========== GESTION DES FORMULAIRES ==========
    function openNewTrade(prefill = {}){
      const modal = document.getElementById('modalBackdrop');
      modal.style.display='flex';
      document.getElementById('modalTitle').textContent = prefill.id ? 'Modifier trade' : 'Nouveau trade';
      document.getElementById('tradeForm').reset();
      document.getElementById('deleteTrade').style.display = prefill.id ? 'inline-block':'none';
      
      for(const k in prefill){ 
        const el = document.getElementById(k); 
        if(el) {
          if (k === 'entry_timestamp' || k === 'exit_timestamp') {
            const date = safeDateParse(prefill[k]);
            if (date) {
              el.value = date.toISOString().slice(0, 16);
            }
          } else {
            el.value = prefill[k]; 
          }
        }
      }
      
      AppState.currentEditing = prefill.id || null;
    }

    function openTradeDetail(id){ 
      const t = AppState.trades.find(x => x.id === id); 
      if(!t) return; 
      openNewTrade(t); 
      AppState.currentEditing = id; 
    }

    // ========== AUTHENTIFICATION ==========
    async function signUp(email, password) {
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        return { success: true, data: userCredential };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }
    
    async function signIn(email, password) {
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        return { success: true, data: userCredential };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }
    
    async function signOut() {
      try {
        await auth.signOut();
        // R√©initialiser l'√©tat pour l'utilisateur guest
        AppState.currentUser = null;
        AppState.currentEditing = null;
        AppState.loadFromLocal(); // Recharger les donn√©es guest
        updateUIForUser();
        renderAll();
        showAlert('D√©connexion r√©ussie', 'success');
      } catch (error) {
        console.error('Erreur de d√©connexion:', error);
        showAlert('Erreur lors de la d√©connexion', 'error');
      }
    }
    
    async function checkAuth() {
      return new Promise((resolve) => {
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            console.log('Utilisateur connect√©:', user.email);
            AppState.currentUser = user;
            updateUIForUser();
            
            try {
              await AppState.loadFromCloud();
              showAlert(`Bienvenue ${user.email}`, 'success');
            } catch (error) {
              console.error('Erreur sync cloud:', error);
              showAlert('Connect√© mais erreur de synchronisation', 'warning');
            }
            
            renderAll();
            resolve(true);
          } else {
            console.log('Utilisateur d√©connect√©');
            AppState.currentUser = null;
            AppState.currentEditing = null;
            AppState.loadFromLocal(); // Charger donn√©es guest
            updateUIForUser();
            renderAll();
            resolve(false);
          }
        });
      });
    }

    // ========== SYNCHRONISATION FORC√âE ==========
    async function forceSync() {
      if (!AppState.currentUser) {
        showAlert('Connectez-vous pour synchroniser', 'warning');
        return;
      }
      
      try {
        showToast('Synchronisation en cours...', 'info');
        await AppState.syncToCloud();
        await AppState.loadFromCloud();
        renderAll();
        showToast('Synchronisation termin√©e', 'success');
      } catch (error) {
        console.error('Erreur sync forc√©e:', error);
        showAlert('Erreur de synchronisation', 'error');
      }
    }

    // ========== IMPORT/EXPORT CSV ==========
    function initCSVImport() {
        const csvFileInput = document.getElementById('csvFile');
        const importCSVBtn = document.getElementById('importCSV');
        
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const trades = parseCSV(csvContent);
                    
                    if (trades.length > 0) {
                        const existingIds = new Set(AppState.trades.map(t => t.id));
                        const newTrades = trades.filter(t => !existingIds.has(t.id));
                        
                        if (newTrades.length > 0) {
                            AppState.trades = [...newTrades, ...AppState.trades];
                            AppState.persist();
                            renderAll();
                            showAlert(`${newTrades.length} trades import√©s avec succ√®s!`, 'success');
                        } else {
                            showAlert('Aucun nouveau trade √† importer', 'info');
                        }
                    } else {
                        showAlert('Aucun trade trouv√© dans le fichier', 'warning');
                    }
                } catch (error) {
                    console.error('Erreur import CSV:', error);
                    showAlert('Erreur lors de l\'import CSV: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        if (csvFileInput) {
            csvFileInput.addEventListener('change', handleCSVImport);
        }
        
        if (importCSVBtn) {
            importCSVBtn.addEventListener('click', () => {
                csvFileInput.click();
            });
        }
        
        const btnImport = document.getElementById('btnImport');
        if (btnImport) {
            btnImport.addEventListener('click', () => {
                csvFileInput.click();
            });
        }
    }

    function parseCSV(csvContent) {
        const lines = csvContent.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 2) return [];
        
        const headers = lines[0].split(',').map(h => h.trim());
        const trades = [];
        
        for (let i = 1; i < lines.length; i++) {
            try {
                const values = parseCSVLine(lines[i]);
                const trade = {};
                
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    let value = values[j] || '';
                    
                    if (typeof value === 'string') {
                        value = value.replace(/^"|"$/g, '').trim();
                    }
                    
                    switch (header) {
                        case 'id':
                            trade.id = value || cryptoRandomId();
                            break;
                        case 'symbol':
                            trade.symbol = value;
                            break;
                        case 'side':
                            trade.side = value.toLowerCase();
                            break;
                        case 'entry_price':
                            trade.entry_price = parseFloat(value) || 0;
                            break;
                        case 'exit_price':
                            trade.exit_price = value ? parseFloat(value) : null;
                            break;
                        case 'size':
                            trade.size = parseFloat(value) || 0;
                            break;
                        case 'fees':
                            trade.fees = parseFloat(value) || 0;
                            break;
                        case 'taxes':
                            trade.taxes = parseFloat(value) || 0;
                            break;
                        case 'entry_timestamp':
                            trade.entry_timestamp = value || new Date().toISOString();
                            break;
                        case 'exit_timestamp':
                            trade.exit_timestamp = value || null;
                            break;
                        case 'confidence':
                            trade.confidence = parseInt(value) || 50;
                            break;
                        case 'score':
                            trade.score = parseInt(value) || 50;
                            break;
                        case 'comment':
                            trade.comment = value || '';
                            break;
                        case 'is_backfilled':
                            break;
                        default:
                            break;
                    }
                }
                
                trade.notional = trade.entry_price * trade.size;
                trade.computed_pnl = computePnL(trade);
                trade.duration_seconds = calculateDuration(trade.entry_timestamp, trade.exit_timestamp);
                trade.updated_at = new Date().toISOString();
                
                if (!trade.market) trade.market = 'spot';
                if (!trade.timezone) trade.timezone = 'Europe/Paris';
                
                try {
                    validateTrade(trade);
                    trades.push(trade);
                } catch (validationError) {
                    console.warn('Trade ignor√© (validation failed):', trade, validationError);
                }
                
            } catch (error) {
                console.warn('Ligne CSV ignor√©e (ligne ' + (i + 1) + '):', error);
            }
        }
        
        return trades;
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current);
        return result;
    }

    function exportCSV() {
        const headers = [
            'id', 'symbol', 'side', 'entry_price', 'exit_price', 'size', 
            'fees', 'taxes', 'entry_timestamp', 'exit_timestamp', 
            'confidence', 'score', 'comment', 'market', 'computed_pnl'
        ];
        
        const csvContent = [
            headers.join(','),
            ...AppState.trades.map(trade => 
                headers.map(header => {
                    let value = trade[header];
                    if (value === null || value === undefined) value = '';
                    
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                }).join(',')
            )
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `trades_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('CSV export√© avec succ√®s', 'success');
    }

    // ========== √âV√âNEMENTS ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Initialiser l'√©tat AVANT tout
      AppState.init();
      
      // Initialisations
      initTheme();
      initMobileMenu();
      initQuickAdd();
      initChart();
      initCSVImport();
      initAnalyticsCharts();
      
      // V√©rifier l'authentification
      checkAuth().then(() => {
        renderAll();
        console.log('Application initialis√©e avec', AppState.trades.length, 'trades');
      });
      
      // Navigation
      document.addEventListener('click', (e)=>{
        if (e.target.matches('.nav-item')) {
          document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
          e.target.classList.add('active');
          const view = e.target.getAttribute('data-view');
          showView(view);
        }
        
        if (e.target.matches('.auth-tab')) {
          document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
          e.target.classList.add('active');
          const tabType = e.target.getAttribute('data-tab');
          
          if (tabType === 'login') {
            document.getElementById('authTitle').textContent = 'Connexion';
            document.getElementById('authSubmit').textContent = 'Se connecter';
            document.getElementById('authConfirmPassword').style.display = 'none';
          } else {
            document.getElementById('authTitle').textContent = 'Inscription';
            document.getElementById('authSubmit').textContent = 'S\'inscrire';
            document.getElementById('authConfirmPassword').style.display = 'block';
          }
        }
      });

      // Th√®me
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Authentification
      document.getElementById('btnLogin').addEventListener('click', () => {
        document.getElementById('authModal').style.display = 'flex';
      });
      
      document.getElementById('btnSignup').addEventListener('click', () => {
        document.getElementById('authModal').style.display = 'flex';
        document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector('[data-tab="signup"]').classList.add('active');
        document.getElementById('authTitle').textContent = 'Inscription';
        document.getElementById('authSubmit').textContent = 'S\'inscrire';
        document.getElementById('authConfirmPassword').style.display = 'block';
      });
      
      document.getElementById('btnLogout').addEventListener('click', signOut);
      
      // Formulaire d'authentification
      document.getElementById('authForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const isLogin = document.getElementById('authTitle').textContent === 'Connexion';
        
        let result;
        if (isLogin) {
          result = await signIn(email, password);
        } else {
          const confirmPassword = document.getElementById('confirmPassword').value;
          if (password !== confirmPassword) {
            document.getElementById('authMessage').textContent = 'Les mots de passe ne correspondent pas';
            document.getElementById('authMessage').style.color = 'var(--accent-red)';
            return;
          }
          result = await signUp(email, password);
        }
        
        if (result.success) {
          document.getElementById('authMessage').textContent = isLogin ? 'Connexion r√©ussie!' : 'Inscription r√©ussie!';
          document.getElementById('authMessage').style.color = 'var(--accent-green)';
          setTimeout(() => {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authForm').reset();
          }, 1500);
        } else {
          document.getElementById('authMessage').textContent = result.error;
          document.getElementById('authMessage').style.color = 'var(--accent-red)';
        }
      });
      
      // Fermer les modals
      document.getElementById('closeAuthModal').addEventListener('click', () => {
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('authForm').reset();
      });
      
      // Nouveau trade
      document.getElementById('btnNewTrade').addEventListener('click', () => openNewTrade());
      document.getElementById('openNew').addEventListener('click', () => openNewTrade());
      document.getElementById('fabButton').addEventListener('click', () => openNewTrade());
      
      // Fermer modal
      document.getElementById('closeModal').addEventListener('click', () => { 
        document.getElementById('modalBackdrop').style.display = 'none'; 
        AppState.currentEditing = null; 
      });

      // Plein √©cran
      document.querySelector('.chart-fullscreen-btn').addEventListener('click', () => {
        document.getElementById('chartModal').style.display = 'flex';
        setTimeout(() => {
          initFullscreenCharts();
        }, 100);
      });
      
      document.getElementById('closeChartModal').addEventListener('click', () => {
        document.getElementById('chartModal').style.display = 'none';
        Object.values(fullscreenCharts).forEach(chart => {
          if (chart) chart.destroy();
        });
        fullscreenCharts = {};
      });

      // Cases √† cocher plein √©cran
      document.querySelectorAll('.chart-checkbox input').forEach(checkbox => {
        checkbox.addEventListener('change', updateFullscreenCharts);
      });

      // Sauvegarder capital
      document.getElementById('saveCapital').addEventListener('click', () => {
        const v = document.getElementById('topCapital').value;
        const num = parseFloat(v);
        if(isNaN(num) || num < 0) {
          showAlert('Capital non valide. Doit √™tre un nombre positif.', 'error');
          return;
        }
        AppState.capital = num; 
        AppState.persistToLocal();
        renderStats();
        showAlert('Capital sauvegard√©: ‚Ç¨'+num.toFixed(2), 'success');
      });

      // Synchronisation
      document.getElementById('btnSyncNow').addEventListener('click', forceSync);

      // Formulaire de trade
      document.getElementById('tradeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          const fd = new FormData(document.getElementById('tradeForm'));
          const t = Object.fromEntries(fd.entries());
          
          t.size = parseFloat(t.size || 0);
          t.entry_price = parseFloat(t.entry_price || 0);
          t.exit_price = t.exit_price ? parseFloat(t.exit_price) : null;
          t.fees = parseFloat(t.fees || 0);
          t.taxes = parseFloat(t.taxes || 0);
          t.confidence = parseInt(t.confidence || 0);
          t.score = parseInt(t.score || 0);
          
          t.entry_timestamp = t.entry_timestamp ? new Date(t.entry_timestamp).toISOString() : new Date().toISOString();
          t.exit_timestamp = t.exit_timestamp ? new Date(t.exit_timestamp).toISOString() : null;
          
          validateTrade(t);
          
          t.notional = (t.entry_price || 0) * (t.size || 0);
          t.computed_pnl = computePnL(t);
          t.duration_seconds = calculateDuration(t.entry_timestamp, t.exit_timestamp);
          t.updated_at = new Date().toISOString();
          
          if(AppState.currentEditing){
            const idx = AppState.trades.findIndex(x => x.id === AppState.currentEditing);
            if(idx >= 0){ 
              t.id = AppState.currentEditing; 
              AppState.trades[idx] = t; 
            }
          } else { 
            t.id = cryptoRandomId(); 
            AppState.trades.unshift(t); 
          }
          
          if (await AppState.persist()) {
            renderAll(); 
            document.getElementById('modalBackdrop').style.display = 'none'; 
            AppState.currentEditing = null; 
            document.getElementById('tradeForm').reset();
            showAlert(AppState.currentEditing ? 'Trade modifi√© avec succ√®s!' : 'Trade cr√©√© avec succ√®s!', 'success');
          }
        } catch (error) {
          showAlert('Erreur: ' + error.message, 'error');
        }
      });

      // Recherche avec debounce
      const searchInput = document.getElementById('globalSearch');
      if (searchInput) {
        searchInput.addEventListener('input', debounce((e) => {
          console.log('Recherche:', e.target.value);
        }, 300));
      }

      // Boutons suppl√©mentaires
      document.getElementById('btnNowEntry').addEventListener('click', () => {
        document.getElementById('entry_timestamp').value = new Date().toISOString().slice(0, 16);
      });
      
      document.getElementById('btnNowExit').addEventListener('click', () => {
        document.getElementById('exit_timestamp').value = new Date().toISOString().slice(0, 16);
      });
      
      document.getElementById('markBackfill').addEventListener('click', () => {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('entry_timestamp').value = yesterday.toISOString().slice(0, 16);
      });
      
      document.getElementById('deleteTrade').addEventListener('click', () => {
        if (AppState.currentEditing) {
          AppState.trades = AppState.trades.filter(t => t.id !== AppState.currentEditing);
          AppState.persist();
          renderAll();
          document.getElementById('modalBackdrop').style.display = 'none';
          showAlert('Trade supprim√©', 'success');
        }
      });

      // Export CSV
      document.getElementById('exportCSV').addEventListener('click', exportCSV);
      document.getElementById('exportCSV2').addEventListener('click', exportCSV);

      // Debug
      window.debugAppState = function() {
        console.log('=== DEBUG APP STATE ===');
        console.log('Utilisateur:', AppState.currentUser?.email);
        console.log('Nombre de trades:', AppState.trades.length);
        console.log('Capital:', AppState.capital);
        console.log('=======================');
      };
    });
  </script>
</body>
</html>
